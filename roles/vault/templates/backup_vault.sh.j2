#!/bin/bash

set -euo pipefail

# Configuration
BACKUP_DIR="{{backup_dir}}"
RETENTION_DAYS=30
TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
BACKUP_FILE="${BACKUP_DIR}/vault_backup_${TIMESTAMP}.snap"
LATEST_SYMLINK="${BACKUP_DIR}/latest.snap"
LOG_FILE="/var/log/backup_vault.log"
APPROLE_TOKEN="{{approle_token.stdout}}"
VAULT_URL="http://{{vault_ip}}:8200"

# Makes sure backup folder exists
mkdir -p "$BACKUP_DIR"

# Create backup
VAULT_TOKEN="$APPROLE_TOKEN" VAULT_ADDR="$VAULT_URL" \
  vault operator raft snapshot save "$BACKUP_FILE"

# Create symlink for latest backup
ln -sf "$(basename "$BACKUP_FILE")" "$LATEST_SYMLINK"

# Remove backups older than 30 days
find "$BACKUP_DIR" -name 'vault_backup_*.snap' -type f -mtime +$RETENTION_DAYS -exec rm {} \;

echo "Backup skapad: $BACKUP_FILE" >> $LOG_FILE
